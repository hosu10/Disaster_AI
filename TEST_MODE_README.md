# DisasterTV_AI_Call.py 테스트 모드 사용 가이드

## 개요
`DisasterTV_AI_Call.py`는 원본 `DisasterTV_AI.py`에 테스트 모드 기능을 추가한 버전입니다.
키보드 'm' 키를 입력하면 CAP 메시지 수신 및 티커 확인 시뮬레이션을 통해 AI 호출을 테스트할 수 있습니다.

## 주요 변경사항

### 1. 테스트 모드 추가 ('m' 키)
- **위치**: `video_monitor` 함수 내 키보드 입력 처리 부분
- **기능**: 
  - CAP 메시지 수신 시뮬레이션
  - 티커 확인 상태 시뮬레이션
  - 현재 프레임으로 AI 호출 실행

### 2. 동작 방식

#### 'm' 키 입력 시:
1. **테스트용 CAP 데이터 생성**
   - `list_json_cap`이 비어있으면 테스트용 CAP 데이터를 자동 생성
   - 기존 CAP 데이터가 있으면 그것을 사용

2. **티커 상태 시뮬레이션**
   - `ticker_state` = True로 가정
   - `ticker_state_duration` = `delay_subtitle + 1` 초로 설정
   - `subtitle_processed` = False로 설정하여 AI 호출 가능하게 함

3. **AI 호출 실행**
   - 현재 프레임으로 `subtitle_check_AI` 함수를 스레드로 실행
   - 화면 캡쳐 이미지 저장 (`test_ai_check_*.png`)

## 사용 방법

### 1. 프로그램 실행
```bash
python DisasterTV_AI_Call.py
```

### 2. 테스트 모드 실행
1. 프로그램이 실행되고 비디오 화면이 표시되면
2. **'m' 키를 입력**
3. 로그에서 다음 메시지 확인:
   - `[TEST-MODE]> 테스트 모드 시작 - 'm' 키 입력 감지`
   - `[TEST-MODE]> 테스트용 CAP 데이터 추가: 테스트재난`
   - `[TEST-MODE]> 티커 상태 시뮬레이션: ticker_state=True, duration=9.00초`
   - `[TEST-MODE]> 재난 AI 호출 (테스트 모드) : 테스트재난`
   - `[GPT-X]> API 호출 시작 - 재난유형: 테스트재난`
   - `[GPT-X]> API 호출 완료 - 재난유형: 테스트재난`
   - `[GPT-X]> AI 0번째 재난[ 테스트재난] 메시지 비교 결과 = True/False | ...`

### 3. 결과 확인
- **로그 파일**: `resources/disaster_log.log`
- **캡쳐 이미지**: `temp/test_ai_check_*.png`
- **저장된 화면**: `path_capture` 경로에 저장 (일치 시)

## 키보드 단축키

| 키 | 기능 |
|---|---|
| `q` | 프로그램 종료 |
| `b` | 상태 로그 출력 및 일일 리포트 생성 |
| `a` | 오디오 on/off 토글 (RTMP 소스일 때) |
| **`m`** | **테스트 모드 실행** (신규 추가) |

## 테스트 시나리오

### 시나리오 1: 기본 테스트
1. 프로그램 실행
2. 비디오 화면 표시 확인
3. 'm' 키 입력
4. AI 호출 및 결과 확인

### 시나리오 2: 실제 CAP 데이터와 함께 테스트
1. 실제 CAP 파일이 `path_cap` 폴더에 있는 상태에서 프로그램 실행
2. CAP 모니터가 CAP 데이터를 수신하여 `list_json_cap`에 추가
3. 'm' 키 입력
4. 실제 CAP 데이터로 AI 호출 테스트

### 시나리오 3: 연속 테스트
1. 'm' 키를 여러 번 입력하여 연속 테스트
2. 각 테스트마다 새로운 타임스탬프로 이미지 저장
3. 로그에서 각 테스트 결과 확인

## 주의사항

1. **API 키 확인**: OpenAI API 키가 환경변수 `OPENAI_API_KEY`에 설정되어 있어야 합니다.
2. **비디오 소스**: 비디오 소스가 연결되어 있어야 현재 프레임을 캡쳐할 수 있습니다.
3. **네트워크**: OpenAI API 호출을 위해 인터넷 연결이 필요합니다.
4. **로그 확인**: 테스트 결과는 로그 파일에서 확인할 수 있습니다.

## 문제 해결

### AI 호출이 실행되지 않는 경우
- 로그에서 `[TEST-MODE]>` 메시지 확인
- `[GPT-X]> API 호출 시작` 메시지 확인
- API 키 및 네트워크 연결 확인

### 오류 발생 시
- 로그에서 `[OPENAI-ERROR-X]` 메시지 확인
- `[GPT]> 예외 상세 정보` 확인
- `handle_openai_error` 함수의 오류 분류 확인

## 코드 위치

- **테스트 모드 코드**: `DisasterTV_AI_Call.py` 1276-1320줄
- **AI 호출 함수**: `subtitle_check_AI` (739-819줄)
- **오류 처리 함수**: `handle_openai_error` (597-734줄)

